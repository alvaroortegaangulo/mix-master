{
    # HTTP/3 is enabled by default since Caddy 2.6.
    # To force protocols explicitly, use: servers { protocols h1 h2 h3 }
}

# Frontend (Next.js)
music-mix-master.com {
    encode zstd gzip

    header {
        Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"
        Pragma "no-cache"
        Expires "0"
    }

    reverse_proxy frontend:3000
}

# Backend API (FastAPI + Hypercorn)
api.music-mix-master.com {
    encode zstd gzip

    header {
        Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"
        Pragma "no-cache"
        Expires "0"
        Access-Control-Allow-Origin  {http.request.header.Origin}
        Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS"
        Access-Control-Allow-Headers "*"
        Access-Control-Allow-Credentials "true"
        Vary "Origin"
    }

    @preflight {
        method OPTIONS
        path  /*
    }
    handle @preflight {
        header Access-Control-Allow-Origin  {http.request.header.Origin}
        header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS"
        header Access-Control-Allow-Headers "*"
        header Access-Control-Allow-Credentials "true"
        respond 204
    }

    reverse_proxy web:8000
}
