name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            # 1. Definir rutas (coincidiendo con tu script)
            APP_DIR="/home/deploy/apps/mix-master"
            
            # 2. Ir a la carpeta
            cd $APP_DIR

            # 3. Descargar 칰ltimos cambios de c칩digo
            echo "游닌 Descargando cambios de Git..."
            git pull origin main

            # 4. INYECTAR LOS SECRETOS (Crear los archivos .env reales)
            echo "游댏 Creando backend/.env..."
            echo "${{ secrets.PROD_ENV_BACKEND }}" > backend/.env
            chmod 600 backend/.env

            echo "游댏 Creando frontend/.env.production..."
            echo "${{ secrets.PROD_ENV_FRONTEND }}" > frontend/.env.production
            chmod 600 frontend/.env.production

            # 5. Ejecutar tu script de deploy (que ya est치 en el VPS)
            echo "游 Ejecutando deploy.sh..."
            # Asumimos que deploy.sh est치 en la ra칤z del proyecto
            bash deploy.sh